
<h1 class="sectionedit1" id="powershell_funktionen">PowerShell Funktionen</h1>
<div class="level1">

<p>
Dies ist eine Auflistung von Funktionen !
</p>

<p>
1. prüft ob eine File oder Verzeichnis vorhanden ist  Ausgabe: True or False
</p>

<p>
<pre class="code powershell">  <span class="kw3">function</span> ExistFolderFile <span class="br0">&#40;</span><span class="re0">$FileFolderValue</span> <span class="sy0">,</span> <span class="re0">$FolderOrFile</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
  <span class="co1">#prüft ob ein Verzeichnis oder Folder Existiert</span>
  <span class="co1"># if (ExistFolderFile &quot;C:\GOTHAER&quot; &quot;folder&quot;) {</span>
  <span class="co1"># Write-Host &quot;es passiert was&quot;</span>
  <span class="co1"># }</span>
  <span class="co1">#</span>
  <span class="re0">$FolderV</span> <span class="sy0">=</span> <span class="st0">&quot;folder&quot;</span><span class="sy0">,</span> <span class="st0">&quot;Folder&quot;</span><span class="sy0">,</span> <span class="st0">&quot;1&quot;</span>
  <span class="re0">$FileV</span> <span class="sy0">=</span> <span class="st0">&quot;File&quot;</span><span class="sy0">,</span> <span class="st0">&quot;file&quot;</span><span class="sy0">,</span> <span class="st0">&quot;0&quot;</span>
  <span class="co1">#Folder</span>
  <span class="kw3">if</span><span class="br0">&#40;</span><span class="re0">$FolderV</span> <span class="kw4">-contains</span> <span class="re0">$FolderOrFile</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw3">if</span><span class="br0">&#40;</span><span class="kw1">Test-Path</span> <span class="re0">$FileFolderValue</span> <span class="kw5">-pathType</span> container<span class="br0">&#41;</span> <span class="br0">&#123;</span>
       <span class="kw1">Write-Host</span> <span class="st0">&quot;exist &quot;</span>  <span class="re0">$FileFolderValue</span>
       <span class="re0">$True</span>
   <span class="br0">&#125;</span> <span class="kw3">else</span> <span class="br0">&#123;</span>
       <span class="kw1">Write-Host</span> <span class="st0">&quot;not exist &quot;</span> <span class="re0">$FileFolderValue</span>
       <span class="re0">$False</span>
          <span class="br0">&#125;</span> 
  <span class="br0">&#125;</span> 
  <span class="co1">#File</span>
  <span class="kw3">elseif</span><span class="br0">&#40;</span><span class="re0">$FileV</span> <span class="kw4">-contains</span> <span class="re0">$FolderOrFile</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw3">if</span><span class="br0">&#40;</span><span class="kw1">Test-Path</span> <span class="re0">$FileFolderValue</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
       <span class="kw1">Write-Host</span> <span class="st0">&quot;exist &quot;</span>  <span class="re0">$FileFolderValue</span>
       <span class="re0">$True</span>
   <span class="br0">&#125;</span> <span class="kw3">else</span> <span class="br0">&#123;</span>
       <span class="kw1">Write-Host</span> <span class="st0">&quot;not exist &quot;</span> <span class="re0">$FileFolderValue</span>
       <span class="re0">$False</span>
         <span class="br0">&#125;</span></pre>

</p>

<p>
2. Diese Funktion erstellt ein Active Setup 
<pre class="code powershell">  <span class="kw3">Function</span> AddToActiveSetup <span class="br0">&#123;</span>
    <span class="kw3">Param</span><span class="br0">&#40;</span>
      <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
        <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$ActiveSetupUniqueName</span><span class="sy0">,</span>
      <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
        <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$ActiveSetupStubPath</span><span class="sy0">,</span>
      <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
        <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$ActiveSetupVersion</span>
       <span class="br0">&#41;</span>
    <span class="re0">$ParentKey</span><span class="sy0">=</span><span class="st0">&quot;HKLM:Software\Microsoft\Active Setup\Installed Components\&quot;</span>
    <span class="re0">$Key</span><span class="sy0">=</span><span class="re0">$ParentKey</span> <span class="sy0">+</span> <span class="st0">&quot;\&quot;</span> <span class="sy0">+</span> <span class="re0">$ActiveSetupUniqueName</span>
    <span class="co1"># Check for key</span>
    <span class="kw3">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="br0">&#40;</span><span class="kw1">Test-Path</span> <span class="re0">$Key</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
      <span class="kw1">New-Item</span> <span class="sy0">-</span><span class="kw2">type</span> Directory $<span class="br0">&#40;</span><span class="re0">$ParentKey</span> <span class="sy0">+</span> <span class="st0">&quot;\&quot;</span> <span class="sy0">+</span> <span class="re0">$ActiveSetupUniqueName</span><span class="br0">&#41;</span>
    <span class="br0">&#125;</span>
    <span class="kw3">else</span> <span class="br0">&#123;</span>
      <span class="kw1">write-host</span> <span class="st0">&quot;Key exists&quot;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">Set-ItemProperty</span> $<span class="br0">&#40;</span><span class="re0">$Key</span><span class="br0">&#41;</span> <span class="kw5">-name</span> <span class="st0">&quot;StubPath&quot;</span> <span class="kw5">-value</span> <span class="re0">$ActiveSetupStubPath</span>
    <span class="kw1">Set-ItemProperty</span> $<span class="br0">&#40;</span><span class="re0">$Key</span><span class="br0">&#41;</span> <span class="kw5">-name</span> <span class="st0">&quot;Version&quot;</span> <span class="kw5">-value</span> <span class="re0">$ActiveSetupVersion</span>.Replace<span class="br0">&#40;</span><span class="st0">'.'</span><span class="sy0">,</span><span class="st0">','</span><span class="br0">&#41;</span>
  <span class="br0">&#125;</span></pre>

</p>

<p>
3. Diese Funktion setzt dauerhaft eine Umgebungsvarivable 
</p>

<p>
<pre class="code powershell">   <span class="kw3">function</span> SetPermamentEnvironmentVariables <span class="br0">&#123;</span>
  <span class="coMULTI">&lt;#
         .Synopsis
            Dieses Skript ändert eine Umgebungsvariablen 
         .Example
           &quot;Modify_Environment_Variable.ps1&quot; osver T6.1
           &quot;Modify_Environment_Variable.ps1&quot; &lt;name&gt; &lt;value&gt;
  #&gt;</span>
     <span class="kw3">param</span><span class="br0">&#40;</span>
       <span class="br0">&#91;</span>Parameter<span class="br0">&#40;</span>Mandatory<span class="sy0">=</span><span class="re0">$True</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
           <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$VAR</span><span class="sy0">,</span>
       <span class="br0">&#91;</span>Parameter<span class="br0">&#40;</span>Mandatory<span class="sy0">=</span><span class="re0">$True</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
           <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$OSVAL</span>
  <span class="br0">&#41;</span>
  <span class="br0">&#91;</span>System.Environment<span class="br0">&#93;</span>::SetEnvironmentVariable<span class="br0">&#40;</span><span class="re0">$VAR</span><span class="sy0">,</span><span class="re0">$OSVAL</span><span class="sy0">,</span> <span class="st0">&quot;Machine&quot;</span><span class="br0">&#41;</span>
  <span class="br0">&#125;</span></pre>

4. Das folgende Skript prüft ob „regedit“ in einem Skript aufgerufen wurde 
</p>

<p>
<pre class="code powershell">  <span class="kw1">Get-ChildItem</span> <span class="kw5">-Recurse</span> <span class="kw5">-Include</span> <span class="sy0">@</span><span class="br0">&#40;</span><span class="st0">&quot;*.sh&quot;</span><span class="sy0">,</span><span class="st0">&quot;*.ps1&quot;</span><span class="sy0">,</span><span class="st0">&quot;*.bat&quot;</span><span class="sy0">,</span><span class="st0">&quot;*.cmd&quot;</span><span class="sy0">,</span><span class="st0">&quot;*.vbs&quot;</span><span class="br0">&#41;</span> <span class="sy0">|</span> <span class="kw1">Select-String</span> <span class="st0">&quot;regedit /s&quot;</span> <span class="sy0">|</span> <span class="kw1">foreach-object</span> <span class="br0">&#123;</span>
     <span class="st0">&quot;Datei: &quot;</span> <span class="sy0">+</span> <a href="about:blank"><span class="kw6">$_</span></a>.Path
     <span class="st0">&quot;Zeile No: &quot;</span> <span class="sy0">+</span> <a href="about:blank"><span class="kw6">$_</span></a>.LineNumber
     <span class="st0">&quot;Zeile: &quot;</span> <span class="sy0">+</span> <a href="about:blank"><span class="kw6">$_</span></a>.Line
     <span class="st0">&quot;&quot;</span>
  <span class="br0">&#125;</span></pre>

5. Bearbeitet eine Bioseinstellung (nur Lenovo)
<pre class="code powershell"><span class="re0">$SATAControllerMode</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw2">gwmi</span> <span class="kw5">-class</span> Lenovo_BiosSetting <span class="kw5">-namespace</span> root\wmi <span class="sy0">|</span> <span class="kw1">Where-Object</span>  <span class="br0">&#123;</span><a href="about:blank"><span class="kw6">$_</span></a>.CurrentSetting.split<span class="br0">&#40;</span><span class="st0">&quot;,&quot;</span><span class="sy0">,</span><span class="br0">&#91;</span>StringSplitOptions<span class="br0">&#93;</span>::RemoveEmptyEntries<span class="br0">&#41;</span> <span class="kw4">-eq</span>   <span class="st0">&quot;SATAControllerMode&quot;</span><span class="br0">&#125;</span><span class="br0">&#41;</span>.CurrentSetting <span class="co1">#| Format-List CurrentSetting</span>
  <span class="kw3">if</span> <span class="br0">&#40;</span><span class="re0">$SATAControllerMode</span> <span class="kw4">-like</span> <span class="st0">&quot;SATAControllerMode,AHCI&quot;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="br0">&#40;</span><span class="kw2">gwmi</span> <span class="kw5">-class</span> Lenovo_SetBiosSetting <span class="kw5">-namespace</span> root\wmi<span class="br0">&#41;</span>.SetBiosSetting<span class="br0">&#40;</span><span class="st0">&quot;SATAControllerMode,Compatibility,VSmdXPC,ascii,us;&quot;</span><span class="br0">&#41;</span>
   <span class="br0">&#40;</span><span class="kw2">gwmi</span> <span class="kw5">-class</span> Lenovo_SaveBiosSettings <span class="kw5">-namespace</span> root\wmi<span class="br0">&#41;</span>.SaveBiosSettings<span class="br0">&#40;</span><span class="st0">&quot;VSmdXPC,ascii,us&quot;</span><span class="br0">&#41;</span>
   <span class="br0">&#40;</span><span class="kw2">gwmi</span> <span class="kw5">-class</span> Lenovo_SaveBiosSettings <span class="kw5">-namespace</span> root\wmi<span class="br0">&#41;</span>.SaveBiosSettings
  <span class="br0">&#125;</span></pre>

6. Diese Skript benennt den Administrator in admlocal um und schreibt Ihn in den AutoLogon für eine 1 malige Anmeldung. 
<pre class="code powershell">  <span class="co1">#beschreibung : Der admlocal wird 1 mal in den AutoLogon fersetzt um das Profile zu laden </span>
  <span class="co1">#Version : 0.1</span>
  <span class="co1">#Datum : 30.10.2013</span>
  <span class="co1">#Der Administrator wird in admlocal umbenannt</span>
  <span class="re0">$oldName</span> <span class="sy0">=</span> <span class="st0">&quot;Administrator&quot;</span>
  <span class="re0">$newName</span><span class="sy0">=</span><span class="st0">&quot;admlocal&quot;</span>
  <span class="re0">$user</span> <span class="sy0">=</span> <span class="kw1">Get-WMIObject</span> Win32_UserAccount <span class="sy0">-</span><span class="kw3">Filter</span> <span class="st0">&quot;Name='$oldName'&quot;</span>
  <span class="re0">$result</span> <span class="sy0">=</span> <span class="re0">$user</span>.Rename<span class="br0">&#40;</span><span class="re0">$newName</span><span class="br0">&#41;</span>
  <span class="co1">#####################################################################</span>
  <span class="co1"># admlocal wird als WinLogon User gesetzt mit dem Passwort welches beim Deployment vergeben wurden ist (wird von der Policy geändert)</span>
  <span class="kw1">New-ItemProperty</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span> <span class="kw5">-Name</span> <span class="st0">&quot;AutoLogonCount&quot;</span> <span class="kw5">-PropertyType</span> <span class="st0">&quot;DWORD&quot;</span> <span class="kw5">-Value</span> <span class="st0">&quot;1&quot;</span>
  <span class="kw1">New-ItemProperty</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span> <span class="kw5">-Name</span> <span class="st0">&quot;AutoAdminLogon&quot;</span> <span class="kw5">-PropertyType</span> <span class="st0">&quot;DWORD&quot;</span> <span class="kw5">-Value</span> <span class="st0">&quot;1&quot;</span>
  <span class="kw1">New-ItemProperty</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span> <span class="kw5">-Name</span> <span class="st0">&quot;DefaultUserName&quot;</span> <span class="kw5">-PropertyType</span> <span class="st0">&quot;String&quot;</span> <span class="kw5">-Value</span> <span class="st0">&quot;admlocal&quot;</span>
  <span class="kw1">New-ItemProperty</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span> <span class="kw5">-Name</span> <span class="st0">&quot;DefaultPassword&quot;</span> <span class="kw5">-PropertyType</span> <span class="st0">&quot;String&quot;</span> <span class="kw5">-Value</span> <span class="st0">&quot;xxxxxxxxxxxxxxxx&quot;</span>
  <span class="kw1">New-ItemProperty</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;</span> <span class="kw5">-Name</span> <span class="st0">&quot;ShutdownAdmlocal&quot;</span> <span class="kw5">-PropertyType</span> <span class="st0">&quot;String&quot;</span> <span class="kw5">-Value</span> <span class="st0">&quot;cmd /c reg delete HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v ShutdownAdmlocal /f &amp; logoff&quot;</span>
  <span class="co1">################################</span>
  <span class="co1">#nach erfolgreichen abschluß meldet sich der User Wieder ab </span>
  <span class="re0">$acl</span> <span class="sy0">=</span> <span class="kw1">Get-Acl</span> <span class="st0">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;</span>
  <span class="re0">$rule</span> <span class="sy0">=</span> <span class="kw1">New-Object</span> System.Security.AccessControl.RegistryAccessRule <span class="br0">&#40;</span><span class="st0">&quot;admlocal&quot;</span><span class="sy0">,</span><span class="st0">&quot;FullControl&quot;</span><span class="sy0">,</span><span class="st0">&quot;Allow&quot;</span><span class="br0">&#41;</span>
  <span class="re0">$acl</span>.SetAccessRule<span class="br0">&#40;</span><span class="re0">$rule</span><span class="br0">&#41;</span>
  <span class="re0">$acl</span> <span class="sy0">|</span><span class="kw1">Set-Acl</span> <span class="kw5">-Path</span> <span class="st0">&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;</span></pre>

7. SID auslesen 
<pre class="code powershell">  <span class="br0">&#40;</span><span class="br0">&#91;</span><span class="re3">WMI</span><span class="br0">&#93;</span><span class="st0">&quot;root\cimv2:win32_sid.sid='S-1-1-0'&quot;</span><span class="br0">&#41;</span>.accountname</pre>

8. Auslesen des Skriptpfades 
<pre class="code powershell">  <span class="kw3">function</span> ScriptDirectory<span class="br0">&#123;</span>
      <span class="re0">$Invocation</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">Get-Variable</span> MyInvocation <span class="kw5">-Scope</span> <span class="nu0">1</span><span class="br0">&#41;</span>.Value
      <span class="kw1">Split-Path</span> <span class="re0">$Invocation</span>.MyCommand.Path
  <span class="br0">&#125;</span></pre>

9. löscht das %temp% Verzeichnis aller User 
<pre class="code powershell">   <span class="co1">#start-transcript -path &quot;$env:SYSTEMROOT\SCCM\Logs\GoSYS_cleanUserTempFolderErrorLog_100.log&quot;</span>
   <span class="kw3">function</span> Get<span class="sy0">-</span>Profile <span class="br0">&#123;</span>
        <span class="coMULTI">&lt;#
       .Synopsis
              Returns information of profiles for each ever logged on or specified user.
       .Input
               System.String
       .Output
               Objects of profile informations
       .Parameter SID
               Only build results for this list of SIDs.
        .Notes 
               Author:  Daniel Baumann &lt;daniel.baumann@t4m.de&gt;
               Date:    2013-08-21
               Version: 0.2013.8.21
           #&gt;</span>
           <span class="kw3">param</span><span class="br0">&#40;</span>
               <span class="br0">&#91;</span>Parameter<span class="br0">&#40;</span>Position<span class="sy0">=</span><span class="nu0">0</span><span class="sy0">,</span>ValueFromPipeline<span class="sy0">=</span><span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
               <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="re0">$SID</span>
            <span class="br0">&#41;</span>
                Begin <span class="br0">&#123;</span> <span class="re0">$Iam</span> <span class="sy0">=</span> <span class="re0">$MyInvocation</span>.MyCommand.Name; <span class="kw1">Write-Verbose</span> <span class="st0">&quot;$Iam:: Function started&quot;</span> <span class="br0">&#125;</span>
                Process <span class="br0">&#123;</span>
                <span class="re0">$CurrentlyLoggedOnUsers</span> <span class="sy0">=</span> `
                <span class="br0">&#40;</span><span class="br0">&#91;</span>Microsoft.Win32.RegistryKey<span class="br0">&#93;</span>::OpenRemoteBaseKey<span class="br0">&#40;</span><span class="br0">&#91;</span>Microsoft.Win32.RegistryHive<span class="br0">&#93;</span>::Users<span class="sy0">,</span> <span class="re0">$env</span>:ComputerName<span class="br0">&#41;</span><span class="br0">&#41;</span>.GetSubKeyNames<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">|</span> `
                <span class="kw1">Where-Object</span> <span class="br0">&#123;</span><span class="br0">&#40;</span><a href="about:blank"><span class="kw6">$_</span></a> <span class="kw4">-notmatch</span> <span class="st0">&quot;_Classes$&quot;</span><span class="br0">&#41;</span> <span class="kw4">-and</span> <span class="br0">&#40;</span><a href="about:blank"><span class="kw6">$_</span></a> <span class="kw4">-notlike</span> <span class="st0">&quot;.DEFAULT&quot;</span><span class="br0">&#41;</span> <span class="kw4">-and</span> <span class="br0">&#40;</span><a href="about:blank"><span class="kw6">$_</span></a> <span class="kw4">-notmatch</span> <span class="st0">&quot;^S-1-5-\d[18|19|20]$&quot;</span><span class="br0">&#41;</span><span class="br0">&#125;</span>
                <span class="re0">$ProfileListRegRoot</span> <span class="sy0">=</span> <span class="st0">'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\ProfileList'</span>
               <span class="kw1">Get-ChildItem</span> <span class="re0">$ProfileListRegRoot</span> <span class="sy0">|</span> `
               <span class="kw1">ForEach-Object</span> <span class="br0">&#123;</span> <a href="about:blank"><span class="kw6">$_</span></a>.PSChildName <span class="br0">&#125;</span> <span class="sy0">|</span> `
               <span class="kw1">Where-Object</span> <span class="br0">&#123;</span><span class="br0">&#40;</span><a href="about:blank"><span class="kw6">$_</span></a> <span class="kw4">-notmatch</span> <span class="st0">&quot;^S-1-5-\d[18|19|20]$&quot;</span><span class="br0">&#41;</span><span class="br0">&#125;</span> <span class="sy0">|</span> `
               <span class="kw1">ForEach-Object</span> <span class="br0">&#123;</span>
                       <span class="kw3">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$SID</span><span class="br0">&#41;</span> <span class="kw4">-and</span> <span class="br0">&#40;</span><span class="re0">$SID</span> <span class="kw4">-notcontains</span> <a href="about:blank"><span class="kw6">$_</span></a><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw3">return</span> <span class="br0">&#125;</span>
                       <span class="re0">$DomainUser</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>System.Security.Principal.SecurityIdentifier<span class="br0">&#93;</span><a href="about:blank"><span class="kw6">$_</span></a><span class="br0">&#41;</span>.Translate<span class="br0">&#40;</span><span class="br0">&#91;</span>System.Security.Principal.NTAccount<span class="br0">&#93;</span><span class="br0">&#41;</span>
                       <span class="re0">$DomainName</span><span class="sy0">,</span> <span class="re0">$UserName</span> <span class="sy0">=</span> <span class="re0">$DomainUser</span> <span class="sy0">-</span>Split <span class="st0">&quot;\\&quot;</span>
                       <span class="re0">$ProfilePath</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">Get-ItemProperty</span> <span class="kw5">-Path</span> <span class="br0">&#40;</span><span class="re0">$ProfileListRegRoot</span> <span class="sy0">+</span> <span class="st0">'\'</span> <span class="sy0">+</span> <a href="about:blank"><span class="kw6">$_</span></a><span class="br0">&#41;</span> <span class="kw5">-Name</span> ProfileImagePath<span class="br0">&#41;</span>.ProfileImagePath
                       <span class="kw3">if</span> <span class="br0">&#40;</span><span class="kw1">Test-Path</span> <span class="re0">$ProfilePath</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                           <span class="re0">$ProfilePathExists</span> <span class="sy0">=</span> <span class="re0">$True</span>
                       <span class="br0">&#125;</span> <span class="kw3">else</span> <span class="br0">&#123;</span>
                           <span class="re0">$ProfilePathExists</span> <span class="sy0">=</span> <span class="re0">$False</span>
                       <span class="br0">&#125;</span>
                       <span class="kw3">if</span> <span class="br0">&#40;</span><span class="re0">$CurrentlyLoggedOnUsers</span> <span class="kw4">-contains</span> <a href="about:blank"><span class="kw6">$_</span></a><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                           <span class="re0">$IsLoggedOn</span> <span class="sy0">=</span> <span class="re0">$True</span>
                       <span class="br0">&#125;</span> <span class="kw3">else</span> <span class="br0">&#123;</span>
                           <span class="re0">$IsLoggedOn</span> <span class="sy0">=</span> <span class="re0">$False</span>
                       <span class="br0">&#125;</span>
                       <span class="kw3">if</span> <span class="br0">&#40;</span><span class="kw1">Test-Path</span> <span class="br0">&#40;</span><span class="re0">$ProfilePath</span> <span class="sy0">+</span> <span class="st0">&quot;\NTUSER.DAT.LOG&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
                               <span class="re0">$LastLogonDate</span> <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">Get-ItemProperty</span> <span class="br0">&#40;</span><span class="re0">$ProfilePath</span> <span class="sy0">+</span> <span class="st0">&quot;\NTUSER.DAT.LOG&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>.LastWriteTime
                       <span class="br0">&#125;</span> <span class="kw3">else</span> <span class="br0">&#123;</span>
                               <span class="re0">$LastLogonDate</span> <span class="sy0">=</span> <span class="re0">$Null</span>
                       <span class="br0">&#125;</span>
                       <span class="kw1">Invoke-Expression</span> <span class="br0">&#40;</span>
                                       <span class="st0">'New-Module -asCustomObject {'</span> <span class="sy0">+</span>
                                       <span class="st0">'$SID = &quot;'</span> <span class="sy0">+</span> <a href="about:blank"><span class="kw6">$_</span></a> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$DomainUser = &quot;'</span> <span class="sy0">+</span> <span class="re0">$DomainUser</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$DomainName = &quot;'</span> <span class="sy0">+</span> <span class="re0">$DomainName</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$UserName = &quot;'</span> <span class="sy0">+</span> <span class="re0">$UserName</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$ProfilePath = &quot;'</span> <span class="sy0">+</span> <span class="re0">$ProfilePath</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$ProfilePathExists = &quot;'</span> <span class="sy0">+</span> <span class="re0">$ProfilePathExists</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$IsLoggedOn = &quot;'</span> <span class="sy0">+</span> <span class="re0">$IsLoggedOn</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'$LastLogonDate = &quot;'</span> <span class="sy0">+</span> <span class="re0">$LastLogonDate</span> <span class="sy0">+</span> <span class="st0">'&quot;;'</span> <span class="sy0">+</span>
                                       <span class="st0">'Export-ModuleMember -Variable *;'</span> <span class="sy0">+</span>
                         <span class="st0">'}'</span>
                     <span class="br0">&#41;</span>
                           <span class="kw3">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$SID</span><span class="br0">&#41;</span> <span class="kw4">-and</span> <span class="br0">&#40;</span><span class="re0">$SID</span> <span class="kw4">-contains</span> <a href="about:blank"><span class="kw6">$_</span></a><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw3">break</span> <span class="br0">&#125;</span>
                 <span class="br0">&#125;</span>
      <span class="br0">&#125;</span>
   End <span class="br0">&#123;</span> <span class="kw1">Write-Verbose</span> <span class="st0">&quot;$Iam:: Function ended&quot;</span> <span class="br0">&#125;</span>
   <span class="br0">&#125;</span>
   new<span class="sy0">-</span>eventlog <span class="kw5">-logname</span> <span class="st0">'CleanUserTempFolder'</span> <span class="sy0">-</span>Source <span class="st0">'CleanUserTempFolder PowerShell Skript'</span> <span class="kw5">-ErrorAction</span> SilentlyContinue
   timeout <span class="nu0">3</span> <span class="nu0">2</span><span class="sy0">&gt;&amp;</span><span class="nu0">1</span> <span class="sy0">|</span> <span class="kw1">Out-Null</span>
   <span class="re0">$Daysback</span> <span class="sy0">=</span> <span class="st0">&quot;-0&quot;</span>
   <span class="re0">$CurrentDate</span> <span class="sy0">=</span> <span class="kw1">Get-Date</span>
    write<span class="sy0">-</span>eventlog <span class="kw5">-logname</span> <span class="st0">'CleanUserTempFolder'</span> <span class="sy0">-</span>source <span class="st0">'CleanUserTempFolder PowerShell Skript'</span> <span class="sy0">-</span>eventID <span class="nu0">1</span> <span class="sy0">-</span>entrytype Information <span class="kw5">-message</span> <span class="st0">&quot;Beginne Benutzer-Temp-Ordner zu leeren.&quot;</span> <span class="kw5">-category</span> <span class="nu0">1</span> <span class="sy0">-</span>rawdata <span class="nu0">10</span><span class="sy0">,</span><span class="nu0">20</span>
      <span class="re0">$DatetoDelete</span> <span class="sy0">=</span> <span class="re0">$CurrentDate</span>.AddDays<span class="br0">&#40;</span><span class="re0">$Daysback</span><span class="br0">&#41;</span>
       timeout <span class="nu0">1</span> <span class="nu0">2</span><span class="sy0">&gt;&amp;</span><span class="nu0">1</span> <span class="sy0">|</span> <span class="kw1">Out-Null</span>
      <span class="br0">&#91;</span><span class="re3">string</span><span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#93;</span><span class="re0">$LISTE</span> <span class="sy0">=</span> <span class="kw3">foreach</span> <span class="br0">&#40;</span><span class="re0">$a</span> <span class="kw3">in</span> <span class="br0">&#40;</span>Get<span class="sy0">-</span>Profile<span class="br0">&#41;</span>.UserName<span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="kw1">Get-ChildItem</span> <span class="st0">&quot;C:\Users\$a\AppData\Local\Temp&quot;</span> <span class="sy0">|</span> <span class="kw1">Where-Object</span> <span class="br0">&#123;</span> <a href="about:blank"><span class="kw6">$_</span></a>.LastWriteTime <span class="kw4">-lt</span> <span class="re0">$DatetoDelete</span> <span class="br0">&#125;</span> <span class="sy0">|</span><span class="kw2">select</span> name<span class="br0">&#125;</span>
      <span class="re0">$EVENTLIST</span> <span class="sy0">=</span> <span class="re0">$LISTE</span>.Replace<span class="br0">&#40;</span><span class="st0">'@{'</span><span class="sy0">,</span><span class="br0">&#41;</span>.Replace<span class="br0">&#40;</span><span class="st0">'}'</span><span class="sy0">,</span><span class="br0">&#41;</span>
      <span class="kw3">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="br0">&#40;</span><span class="re0">$lastExitCode</span> <span class="kw4">-eq</span> <span class="nu0">0</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
         write<span class="sy0">-</span>eventlog <span class="kw5">-logname</span> <span class="st0">'CleanUserTempFolder'</span> <span class="sy0">-</span>source <span class="st0">'CleanUserTempFolder PowerShell Skript'</span> <span class="sy0">-</span>eventID <span class="nu0">19</span> <span class="sy0">-</span>entrytype Information <span class="kw5">-message</span> <span class="st0">&quot;Es müssen keine Daten gelöscht werden.&quot;</span> <span class="kw5">-category</span> <span class="nu0">1</span> <span class="sy0">-</span>rawdata <span class="nu0">10</span><span class="sy0">,</span><span class="nu0">20</span>
      exit 
   <span class="br0">&#125;</span>
  write<span class="sy0">-</span>eventlog <span class="kw5">-logname</span> <span class="st0">'CleanUserTempFolder'</span> <span class="sy0">-</span>source <span class="st0">'CleanUserTempFolder PowerShell Skript'</span> <span class="sy0">-</span>eventID <span class="nu0">1</span> <span class="sy0">-</span>entrytype Warning <span class="kw5">-message</span> <span class="st0">&quot;Diese Dateien und Ordner werden gelöscht: $EVENTLIST &quot;</span>  <span class="kw5">-category</span> <span class="nu0">3</span> <span class="sy0">-</span>rawdata <span class="nu0">10</span><span class="sy0">,</span><span class="nu0">20</span>
  <span class="kw3">foreach</span> <span class="br0">&#40;</span><span class="re0">$a</span> <span class="kw3">in</span> <span class="br0">&#40;</span>Get<span class="sy0">-</span>Profile<span class="br0">&#41;</span>.UserName<span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="kw1">Get-ChildItem</span> <span class="st0">&quot;C:\Users\$a\AppData\Local\Temp&quot;</span> <span class="sy0">|</span> <span class="kw1">Where-Object</span> <span class="br0">&#123;</span> <a href="about:blank"><span class="kw6">$_</span></a>.LastWriteTime <span class="kw4">-lt</span> <span class="re0">$DatetoDelete</span> <span class="br0">&#125;</span> <span class="sy0">|</span><span class="kw1">Remove-Item</span>  <span class="kw5">-Recurse</span>  <span class="nu0">2</span><span class="sy0">&gt;&amp;</span><span class="nu0">1</span> <span class="sy0">|</span> <span class="kw1">Out-Null</span><span class="br0">&#125;</span>
  timeout <span class="nu0">1</span> <span class="nu0">2</span><span class="sy0">&gt;&amp;</span><span class="nu0">1</span> <span class="sy0">|</span> <span class="kw1">Out-Null</span>
  write<span class="sy0">-</span>eventlog <span class="kw5">-logname</span> <span class="st0">'CleanUserTempFolder'</span> <span class="sy0">-</span>source <span class="st0">'CleanUserTempFolder PowerShell Skript'</span> <span class="sy0">-</span>eventID <span class="nu0">19</span> <span class="sy0">-</span>entrytype Information <span class="kw5">-message</span> <span class="st0">&quot;Benutzer-Temp-Ordner leeren ist beendet.&quot;</span> <span class="kw5">-category</span> <span class="nu0">1</span> <span class="sy0">-</span>rawdata <span class="nu0">10</span><span class="sy0">,</span><span class="nu0">20</span>
  <span class="co1">#stop-transcript</span></pre>

10. Die folgende Funktion fragt eine Datenbank ab.
<pre class="code powershell">  <span class="kw3">Function</span> MSSQLQuery <span class="br0">&#123;</span>
     <span class="coMULTI">&lt;#
           .Synopsis
              Ruft ein T-SQL Skript in der PowerShell auf  !!
           .PARAMETER
              -SQLServer   &lt;SQLServerName&gt; angabe des SQL-Servers
              -SQLDBName   &lt;DatenbankName&gt; angabe der Datenbank
              -SQLQuery    &lt;T-SQL Skript&gt;  angabe des T-SQL Skriptes einfache abfrage select * from 'mamam' 
              -UserName    &lt;Username&gt;      angabe des Datenbank Benutzers (optinal)
              -Password    &lt;User Passwort&gt; angabe des Passwortes des Datenbank Benutzers (optional)
           .Example
              MSSQLQuery -SQLServer &quot;klnsv838&quot; -SQLDBName &quot;RolloutWin7&quot; -SQLQuery &quot;select * from Computers where ComputerName like 'STGWSG13%'&quot; -UserName &quot;sbquery&quot; -password 'xxxxxx'
              MSSQLQuery -SQLServer &quot;klnsv838&quot; -SQLDBName &quot;RolloutWin7&quot; -SQLQuery &quot;select * from Computers where ComputerName like 'KLNWSA31'&quot;
              MSSQLQuery -SQLServer &quot;klnsv838&quot; -SQLDBName &quot;RolloutWin7&quot; -SQLQuery &quot;select * from Computers where ComputerName like 'KLNWSA31'&quot;            
              $var = (MSSQLQuery -SQLServer &quot;klnsv838&quot; -SQLDBName &quot;SMS_GOP&quot; -SQLQuery &quot;SELECT NewHash FROM SMSPackages WHERE PkgID='GOP009CC'&quot; -UserName &quot;sbquery&quot; -password 'xxxxx').NewHash
    #&gt;</span>
      <span class="kw3">Param</span><span class="br0">&#40;</span>
        <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
          <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$SQLServer</span><span class="sy0">,</span>
        <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
          <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$SQLDBName</span><span class="sy0">,</span>
        <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$true</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
          <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$SQLQuery</span><span class="sy0">,</span>
        <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$false</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
          <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$UserName</span><span class="sy0">,</span>
        <span class="br0">&#91;</span>parameter<span class="br0">&#40;</span>Mandatory <span class="sy0">=</span> <span class="re0">$false</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
          <span class="br0">&#91;</span><span class="re3">String</span><span class="br0">&#93;</span><span class="re0">$password</span>
         <span class="br0">&#41;</span>
  <span class="re0">$SqlConnection</span> <span class="sy0">=</span> <span class="kw1">New-Object</span> System.Data.SqlClient.SqlConnection
  <span class="kw3">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$UserName</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="re0">$SqlConnection</span>.ConnectionString <span class="sy0">=</span> <span class="st0">&quot;Server = $SQLServer; Database = $SQLDBName; Integrated Security = True;&quot;</span>
  <span class="br0">&#125;</span><span class="kw3">else</span><span class="br0">&#123;</span>
      <span class="re0">$SqlConnection</span>.ConnectionString <span class="sy0">=</span> <span class="st0">&quot;Server = $SQLServer; Database = $SQLDBName; User ID=$UserName; Password=$password;&quot;</span> <span class="co1"># ohne User Integrated Security = True;</span>
  <span class="br0">&#125;</span>
  <span class="re0">$SqlCmd</span> <span class="sy0">=</span> <span class="kw1">New-Object</span> System.Data.SqlClient.SqlCommand
  <span class="re0">$SqlCmd</span>.CommandText <span class="sy0">=</span> <span class="re0">$SqlQuery</span>
  <span class="re0">$SqlCmd</span>.Connection <span class="sy0">=</span> <span class="re0">$SqlConnection</span>
  <span class="re0">$SqlAdapter</span> <span class="sy0">=</span> <span class="kw1">New-Object</span> System.Data.SqlClient.SqlDataAdapter
  <span class="re0">$SqlAdapter</span>.SelectCommand <span class="sy0">=</span> <span class="re0">$SqlCmd</span>
  <span class="re0">$DataSet</span> <span class="sy0">=</span> <span class="kw1">New-Object</span> System.Data.DataSet
  <span class="re0">$SqlAdapter</span>.Fill<span class="br0">&#40;</span><span class="re0">$DataSet</span><span class="br0">&#41;</span>
  <span class="re0">$SqlConnection</span>.Close<span class="br0">&#40;</span><span class="br0">&#41;</span>
  <span class="kw2">clear</span>
  <span class="br0">&#40;</span><span class="re0">$DataSet</span>.Tables<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
   <span class="br0">&#125;</span></pre>

</p>

<p>
Client einer Collection hinzufügen. 
<pre class="code powershell">Add<span class="sy0">-</span>CMDeviceCollectionDirectMembershipRule <span class="sy0">-</span>CollectionId UBA0001B <span class="sy0">-</span>ResourceId <span class="br0">&#40;</span>Get<span class="sy0">-</span>CMDevice <span class="kw5">-name</span> PC62479<span class="br0">&#41;</span>.Res
ourceID</pre>

</p>

</div>
